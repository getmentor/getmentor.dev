# Observability Quick Reference

## Common Tasks

### Check Metrics Endpoint
```bash
curl http://localhost:3000/api/metrics
```

### View Specific Metric
```bash
curl -s http://localhost:3000/api/metrics | grep "nextjs_http_requests_total"
```

### Check Grafana Agent Status (in Docker)
```bash
docker exec <container-id> ps aux | grep grafana-agent
```

### View Application Logs (in Docker)
```bash
docker exec <container-id> cat /app/logs/app.log
docker exec <container-id> tail -f /app/logs/app.log  # Follow logs
```

### View Error Logs Only
```bash
docker exec <container-id> cat /app/logs/error.log
```

### Change Log Level
```bash
# In .env or environment
LOG_LEVEL=debug  # debug|info|warn|error
```

## Adding Observability to New Code

### 1. Wrap API Route Handler
```javascript
// Before
export default handler

// After
import { withObservability } from '../../lib/with-observability'
export default withObservability(handler)
```

### 2. Add Custom Counter
```javascript
import { contactFormSubmissions } from '../../lib/metrics'

// Increment counter
contactFormSubmissions.inc({ status: 'success' })
contactFormSubmissions.inc({ status: 'error' })
```

### 3. Measure Operation Duration
```javascript
import { measureAsync } from '../../lib/with-observability'
import { azureStorageRequestDuration } from '../../lib/metrics'

const result = await measureAsync(
  azureStorageRequestDuration,
  { operation: 'upload', status: 'success' },
  async () => {
    return await uploadToAzure(data)
  }
)
```

### 4. Log Information
```javascript
import logger from '../../lib/logger'

logger.info('User action', { userId: user.id, action: 'profile_update' })
logger.warn('Deprecated API used', { endpoint: '/old-api' })
logger.error('Operation failed', { error: err.message, stack: err.stack })
```

### 5. Log Errors with Context
```javascript
import { logError } from '../../lib/logger'

try {
  await riskyOperation()
} catch (error) {
  logError(error, {
    userId: req.user?.id,
    operation: 'riskyOperation',
    input: req.body
  })
  throw error
}
```

### 6. Create Context Logger
```javascript
import { createContextLogger } from '../../lib/logger'

const logger = createContextLogger({
  userId: user.id,
  requestId: req.id
})

logger.info('Started processing')
logger.info('Completed processing')
// All logs will include userId and requestId
```

## Useful Prometheus Queries

### Request Rate (per second)
```promql
rate(nextjs_http_requests_total[5m])
```

### Error Rate
```promql
rate(nextjs_http_requests_total{status_code=~"5.."}[5m])
```

### 95th Percentile Response Time
```promql
histogram_quantile(0.95, rate(nextjs_http_request_duration_seconds_bucket[5m]))
```

### Cache Hit Ratio
```promql
sum(rate(nextjs_cache_hits_total[5m])) /
(sum(rate(nextjs_cache_hits_total[5m])) + sum(rate(nextjs_cache_misses_total[5m])))
```

### Memory Usage
```promql
nextjs_process_resident_memory_bytes
```

### Airtable API Error Rate
```promql
rate(nextjs_airtable_requests_total{status="error"}[5m])
```

## Troubleshooting

### Metrics Not Updating
1. Check `/api/metrics` endpoint is accessible
2. Verify code is being executed (add console.log temporarily)
3. Check metric labels match what's defined in metrics.js

### Logs Not Appearing
1. Verify LOG_DIR environment variable
2. Check file permissions on /app/logs/
3. Ensure NODE_ENV is set correctly
4. Look for "Could not initialize file logging" warnings

### Grafana Agent Not Sending Data
1. Check environment variables are set (GRAFANA_CLOUD_*)
2. Verify network connectivity to Grafana Cloud
3. Check Docker logs for agent errors: `docker logs <container>`
4. Validate Grafana Cloud credentials

### High Memory Usage
1. Check metrics scrape interval (default 60s)
2. Reduce log retention or file size limits
3. Check for metric label cardinality issues

## Best Practices

### Metric Labels
✅ **Good** - Low cardinality
```javascript
metric.inc({ status: 'success', operation: 'fetch' })
```

❌ **Bad** - High cardinality (avoid user IDs, timestamps, etc.)
```javascript
metric.inc({ userId: '12345', timestamp: Date.now() })
```

### Logging
✅ **Good** - Structured with context
```javascript
logger.info('User logged in', { userId: user.id, method: 'oauth' })
```

❌ **Bad** - Unstructured string concatenation
```javascript
logger.info(`User ${user.id} logged in via oauth`)
```

### Error Handling
✅ **Good** - Log with context, then handle
```javascript
try {
  await operation()
} catch (error) {
  logError(error, { context: 'important info' })
  return res.status(500).json({ error: 'Failed' })
}
```

❌ **Bad** - Silent failure
```javascript
try {
  await operation()
} catch (error) {
  // Nothing
}
```

## Environment Variables Checklist

Required for production observability:
- [ ] GRAFANA_CLOUD_METRICS_URL
- [ ] GRAFANA_CLOUD_METRICS_USERNAME
- [ ] GRAFANA_CLOUD_LOGS_URL
- [ ] GRAFANA_CLOUD_LOGS_USERNAME
- [ ] GRAFANA_CLOUD_API_KEY
- [ ] LOG_LEVEL (optional, defaults to 'info')
- [ ] LOG_DIR (optional, defaults to '/app/logs')

Optional for traces:
- [ ] GRAFANA_CLOUD_TRACES_URL
- [ ] GRAFANA_CLOUD_TRACES_USERNAME

## Testing Checklist

Before deploying:
- [ ] Run `yarn build` successfully
- [ ] Access `/api/metrics` and verify output
- [ ] Check logs appear in console (dev) or files (prod)
- [ ] Verify Grafana Agent starts in Docker
- [ ] Confirm metrics appear in Grafana Cloud
- [ ] Confirm logs appear in Grafana Cloud Loki
- [ ] Test error scenarios produce appropriate logs
- [ ] Verify cache metrics update correctly

## Quick Metrics Reference

| Metric | Type | Description | Labels |
|--------|------|-------------|--------|
| `nextjs_http_requests_total` | Counter | Total HTTP requests | method, route, status_code |
| `nextjs_http_request_duration_seconds` | Histogram | Request duration | method, route, status_code |
| `nextjs_http_active_requests` | Gauge | Active requests | method, route |
| `nextjs_cache_hits_total` | Counter | Cache hits | cache_name |
| `nextjs_cache_misses_total` | Counter | Cache misses | cache_name |
| `nextjs_airtable_requests_total` | Counter | Airtable API calls | operation, status |
| `nextjs_process_resident_memory_bytes` | Gauge | Memory usage | - |
| `nextjs_nodejs_eventloop_lag_seconds` | Gauge | Event loop lag | - |
