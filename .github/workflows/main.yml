name: CI

on:
  # Triggers on push to main and pull requests to any branch
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Allows manual trigger from Actions tab
  workflow_dispatch:

jobs:
  # Lint, type check, and test
  test:
    name: Lint, Type Check & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        run: yarn lint

      - name: Run TypeScript type check
        run: npx tsc --noEmit

      - name: Run tests
        run: yarn test

  # Build the application
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test

    env:
      AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      AZURE_STORAGE_DOMAIN: ${{ secrets.AZURE_STORAGE_DOMAIN }}
      NEXT_PUBLIC_AZURE_STORAGE_DOMAIN: ${{ secrets.NEXT_PUBLIC_AZURE_STORAGE_DOMAIN }}
      NEXT_PUBLIC_GO_API_URL: ${{ secrets.NEXT_PUBLIC_GO_API_URL }}
      NEXT_PUBLIC_RECAPTCHA_V2_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_V2_SITE_KEY }}
      NEXT_PUBLIC_YANDEX_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_YANDEX_STORAGE_BUCKET }}
      NEXT_PUBLIC_YANDEX_STORAGE_ENDPOINT: ${{ secrets.NEXT_PUBLIC_YANDEX_STORAGE_ENDPOINT }}
      NEXT_PUBLIC_CDN_ENDPOINT: ${{ secrets.NEXT_PUBLIC_CDN_ENDPOINT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build
